<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
  <meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />

  <title>Class: RubyWiki</title>

  <link rel="stylesheet" href="./rdoc.css" type="text/css" media="screen" />

  <script src="./js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/thickbox-compressed.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/quicksearch.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/darkfish.js" type="text/javascript" charset="utf-8"></script>

</head>
<body id="top" class="class">

  <div id="metadata">
    <div id="home-metadata">
      <div id="home-section" class="section">
        <h3 class="section-header">
          <a href="./index.html">Home</a>
          <a href="./index.html#classes">Classes</a>
          <a href="./index.html#methods">Methods</a>
        </h3>
      </div>
    </div>

    <div id="file-metadata">
      <div id="file-list-section" class="section">
        <h3 class="section-header">In Files</h3>
        <div class="section-body">
          <ul>
          
            <li><a href="./init_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="init.rb">init.rb</a></li>
          
            <li><a href="./query_rb.html?TB_iframe=true&amp;height=550&amp;width=785"
              class="thickbox" title="query.rb">query.rb</a></li>
          
          </ul>
        </div>
      </div>

      
    </div>

    <div id="class-metadata">
      
      <!-- Parent Class -->
      <div id="parent-class-section" class="section">
        <h3 class="section-header">Parent</h3>
        
        <p class="link"><a href="Object.html">Object</a></p>
        
      </div>
      

      

      

      
      <!-- Method Quickref -->
      <div id="method-list-section" class="section">
        <h3 class="section-header">Methods</h3>
        <ul class="link-list">
          
          <li><a href="#method-c-new">::new</a></li>
          
          <li><a href="#method-i-exception">#exception</a></li>
          
          <li><a href="#method-i-finalize">#finalize</a></li>
          
          <li><a href="#method-i-get_api">#get_api</a></li>
          
          <li><a href="#method-i-init_curl-21">#init_curl!</a></li>
          
          <li><a href="#method-i-log">#log</a></li>
          
          <li><a href="#method-i-login-21">#login!</a></li>
          
          <li><a href="#method-i-login_code_check-21">#login_code_check!</a></li>
          
          <li><a href="#method-i-post_api">#post_api</a></li>
          
          <li><a href="#method-i-site_info_general">#site_info_general</a></li>
          
          <li><a href="#method-i-urldecode">#urldecode</a></li>
          
          <li><a href="#method-i-urlencode">#urlencode</a></li>
          
        </ul>
      </div>
      

      
    </div>

    <div id="project-metadata">
      
      

      <div id="classindex-section" class="section project-section">
        <h3 class="section-header">Class/Module Index
          <span class="search-toggle"><img src="./images/find.png"
            height="16" width="16" alt="[+]"
            title="show/hide quicksearch" /></span></h3>
        <form action="#" method="get" accept-charset="utf-8" class="initially-hidden">
        <fieldset>
          <legend>Quicksearch</legend>
          <input type="text" name="quicksearch" value=""
            class="quicksearch-field" />
        </fieldset>
        </form>

        <ul class="link-list">
        
          <li><a href="./RbWikiErr.html">RbWikiErr</a></li>
        
          <li><a href="./RbWikiErr/General.html">RbWikiErr::General</a></li>
        
          <li><a href="./RbWikiErr/Login.html">RbWikiErr::Login</a></li>
        
          <li><a href="./RbWikiErr/Query.html">RbWikiErr::Query</a></li>
        
          <li><a href="./RbWikiErr/Query/General.html">RbWikiErr::Query::General</a></li>
        
          <li><a href="./RbWikiErr/Query/GeneralSiteInfo.html">RbWikiErr::Query::GeneralSiteInfo</a></li>
        
          <li><a href="./Object.html">Object</a></li>
        
          <li><a href="./RubyWiki.html">RubyWiki</a></li>
        
          <li><a href="./RubyWikiError.html">RubyWikiError</a></li>
        
        </ul>
        <div id="no-class-search-results" style="display: none;">No matching classes.</div>
      </div>

      
    </div>
  </div>

  <div id="documentation">
    <h1 class="class">RubyWiki</h1>

    <div id="description" class="description">
      
<p>This is the main <a href="RubyWiki.html">RubyWiki</a> class, it contains
all you need to perform actions on a wiki. All requests are done with API
and YAML (built-in version in the standard library)</p>

    </div><!-- description -->

    
    <div id="5Buntitled-5D" class="documentation-section">
      

      

      
      <!-- Constants -->
      <div id="constants-list" class="section">
        <h3 class="section-header">Constants</h3>
        <dl>
        
          <dt><a name="EOL">EOL</a></dt>
          
          <dd class="description"><p>End of line</p></dd>
          
        
          <dt><a name="LL_DEBUG">LL_DEBUG</a></dt>
          
          <dd class="description"><p>Debug Information Log Level, e.g.</p>
<ul><li>
<p><a href="RubyWiki.html">RubyWiki</a> Started</p>
</li><li>
<p>OS: Microsoft Windows 7 Ultimate Edition</p>
</li><li>
<p>Ruby Version 1.9.2-p180</p>
</li></ul></dd>
          
        
          <dt><a name="LL_ERROR">LL_ERROR</a></dt>
          
          <dd class="description"><p>Error Log Level, any error that can be caught with rescue</p></dd>
          
        
          <dt><a name="LL_FATAL">LL_FATAL</a></dt>
          
          <dd class="description"><p>Fatal Error Log Level, any error that exits immediately</p></dd>
          
        
          <dt><a name="LL_INFO">LL_INFO</a></dt>
          
          <dd class="description"><p>Information Log Level, e.g.</p>
<ul><li>
<p>User “foo” logged into wiki “bar”</p>
</li></ul></dd>
          
        
          <dt><a name="LL_NOTICE">LL_NOTICE</a></dt>
          
          <dd class="description"><p>Notice Log Level, any information that have more powerful meaning that
normal information</p></dd>
          
        
          <dt><a name="LL_WARN">LL_WARN</a></dt>
          
          <dd class="description"><p>Warning Log Level, errors that happened but <a
href="RubyWiki.html">RubyWiki</a> can handle it</p></dd>
          
        
        </dl>
      </div>
      

      

      <!-- Methods -->
      
      <div id="public-class-method-details" class="method-section section">
        <h3 class="section-header">Public Class Methods</h3>

      
        <div id="new-method" class="method-detail ">
          <a name="method-c-new"></a>

          
          <div class="method-heading">
            <span class="method-name">new</span><span
              class="method-args">(wiki = nil, user = nil, pass = nil, agent = nil, max_lag = nil)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Initialize the whole class, populate class variables with data and login.</p>
<table class="rdoc-list"><tr><td class="rdoc-term"><p>Wiki</p></td>
<td>
<p>The wiki specification to load</p>
</td></tr><tr><td class="rdoc-term"><p>User</p></td>
<td>
<p>The user to use for that wiki</p>
</td></tr><tr><td class="rdoc-term"><p>Agent</p></td>
<td>
<p>The User-Agent to use</p>
</td></tr><tr><td class="rdoc-term"><p>max_lag</p></td>
<td>
<p>Importance of data so MediaWiki knows how to adjust slave DBs to prevent
lag</p>
</td></tr></table>
            

            
            <div class="method-source-code" id="new-source">
<pre>
<span class="ruby-comment"># File init.rb, line 63</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">initialize</span>(<span class="ruby-identifier">wiki</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">user</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">pass</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">agent</span> = <span class="ruby-keyword">nil</span>, <span class="ruby-identifier">max_lag</span> = <span class="ruby-keyword">nil</span>)
        <span class="ruby-comment"># Read Configuration file defined in &quot;initrbw.rb&quot;</span>
        <span class="ruby-ivar">@conf</span> = <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load_file</span> <span class="ruby-constant">ConfigFile</span>
        <span class="ruby-comment"># Get the wiki name to use, from the argument if defined or the configuration</span>
        <span class="ruby-ivar">@wikid</span> = <span class="ruby-identifier">wiki</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">wiki</span> <span class="ruby-operator">:</span> <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'wiki'</span>]

        <span class="ruby-comment"># Load the wiki's configuration</span>
        <span class="ruby-keyword">begin</span>
                <span class="ruby-keyword">if</span> <span class="ruby-constant">File</span>.<span class="ruby-identifier">readable?</span>(<span class="ruby-constant">ConfigDir</span> <span class="ruby-operator">+</span> <span class="ruby-string">'wikis/'</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@wikid</span> <span class="ruby-operator">+</span> <span class="ruby-string">'.yaml'</span>)
                        <span class="ruby-ivar">@wikiconf</span> = <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load_file</span>(<span class="ruby-constant">ConfigDir</span> <span class="ruby-operator">+</span> <span class="ruby-string">'wikis/'</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@wikid</span> <span class="ruby-operator">+</span> <span class="ruby-string">'.yaml'</span>)
                <span class="ruby-keyword">else</span>
                        <span class="ruby-ivar">@wikiconf</span> = <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load_file</span>(<span class="ruby-constant">INC</span> <span class="ruby-operator">+</span> <span class="ruby-string">'../wikis/'</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@wikid</span> <span class="ruby-operator">+</span> <span class="ruby-string">'.yaml'</span>)
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">rescue</span> <span class="ruby-constant">ArgumentError</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">RubyWikiError</span>, <span class="ruby-value">12</span>, <span class="ruby-string">'Invalid Wiki Config'</span>
        <span class="ruby-keyword">rescue</span> <span class="ruby-constant">Errno</span><span class="ruby-operator">::</span><span class="ruby-constant">ENOENT</span>
                <span class="ruby-identifier">raise</span> <span class="ruby-constant">RubyWikiError</span>, <span class="ruby-value">13</span>, <span class="ruby-string">'Wiki doesn\t exist'</span>
        <span class="ruby-keyword">end</span>
        
        <span class="ruby-comment"># Get Wiki Data</span>
        <span class="ruby-comment"># Wiki Name</span>
        <span class="ruby-ivar">@wikiname</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'name'</span>]
        <span class="ruby-comment"># Replicate DB lag level</span>
        <span class="ruby-ivar">@max_lag</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'maxlag'</span>]
        <span class="ruby-comment"># Edit per minute</span>
        <span class="ruby-ivar">@epm</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'epm'</span>]
        <span class="ruby-comment"># Wiki Protocol</span>
        <span class="ruby-ivar">@proto</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'protocol'</span>]
        <span class="ruby-comment"># Wiki Domain</span>
        <span class="ruby-ivar">@host</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'domain'</span>]
        <span class="ruby-comment"># Path to wiki installation directory relative to @host</span>
        <span class="ruby-ivar">@path</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'path'</span>]
        <span class="ruby-comment"># Article Path relative to @host</span>
        <span class="ruby-ivar">@article</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'article'</span>]
        <span class="ruby-comment"># API.php filename</span>
        <span class="ruby-ivar">@api_script</span> = <span class="ruby-ivar">@wikiconf</span>[<span class="ruby-string">'api'</span>]
        <span class="ruby-comment"># End of Get Wiki Data</span>
        
        <span class="ruby-comment"># Merge wiki configuration to make the absolute URL to API.php</span>
        <span class="ruby-ivar">@api_url</span> = <span class="ruby-ivar">@proto</span> <span class="ruby-operator">+</span> <span class="ruby-string">'://'</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@host</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@path</span> <span class="ruby-operator">+</span> <span class="ruby-string">'/'</span> <span class="ruby-operator">+</span> <span class="ruby-ivar">@api_script</span>
        <span class="ruby-comment"># Generate the User-Agent of the Bot</span>
        <span class="ruby-ivar">@useragent</span> = <span class="ruby-identifier">agent</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">agent</span> <span class="ruby-operator">:</span> (
                <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'useragent'</span>] <span class="ruby-operator">==</span> <span class="ruby-string">'default'</span> <span class="ruby-operator">?</span>
                        <span class="ruby-string">'RubyWiki/'</span> <span class="ruby-operator">+</span> <span class="ruby-constant">RBW_VERSION</span> <span class="ruby-operator">:</span>
                        <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'useragent'</span>]
                )
        <span class="ruby-comment"># Figure out the log level</span>
        <span class="ruby-ivar">@loglevel</span> = <span class="ruby-constant">RubyWiki</span><span class="ruby-operator">::</span><span class="ruby-identifier">const_get</span>(<span class="ruby-ivar">@conf</span>[<span class="ruby-string">'loglevel'</span>])
        
        <span class="ruby-comment"># Username and password</span>
        <span class="ruby-comment"># Get the username to use, from the argument if defined or the configuration</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">user</span>
                <span class="ruby-ivar">@user</span> = <span class="ruby-identifier">user</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'user'</span>]
                <span class="ruby-keyword">if</span> <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'users'</span>][<span class="ruby-ivar">@wikid</span>].<span class="ruby-identifier">include?</span><span class="ruby-ivar">@conf</span>[<span class="ruby-string">'user'</span>]
                        <span class="ruby-ivar">@user</span> = <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'user'</span>]
                <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'users'</span>][<span class="ruby-ivar">@wikid</span>][<span class="ruby-value">0</span>]
                        <span class="ruby-ivar">@user</span> = <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'users'</span>][<span class="ruby-ivar">@wikid</span>][<span class="ruby-value">0</span>]
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">exception</span> <span class="ruby-constant">RubyWikiError</span>, <span class="ruby-value">11</span>, <span class="ruby-string">'No Such User'</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">if</span> <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'users'</span>][<span class="ruby-ivar">@wikid</span>][<span class="ruby-value">0</span>]
                        <span class="ruby-ivar">@user</span> = <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'users'</span>][<span class="ruby-ivar">@wikid</span>][<span class="ruby-value">0</span>]
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">exception</span> <span class="ruby-constant">RubyWikiError</span>, <span class="ruby-value">11</span>, <span class="ruby-string">'No Such User'</span>
                <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># Get password</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">pass</span>
                <span class="ruby-ivar">@pass</span> = <span class="ruby-identifier">pass</span>
        <span class="ruby-keyword">elsif</span> <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'pass'</span>][<span class="ruby-ivar">@wikid</span>][<span class="ruby-ivar">@user</span>]
                <span class="ruby-ivar">@pass</span> = <span class="ruby-ivar">@conf</span>[<span class="ruby-string">'pass'</span>][<span class="ruby-ivar">@wikid</span>][<span class="ruby-ivar">@user</span>]
        <span class="ruby-keyword">else</span>
                <span class="ruby-identifier">require</span> <span class="ruby-string">'highline/import'</span>
                <span class="ruby-ivar">@pass</span> = <span class="ruby-identifier">ask</span>(<span class="ruby-node">&quot;Type in the password for #{@user}@#{@wikiname}:&quot;</span>) { <span class="ruby-operator">|</span><span class="ruby-identifier">q</span><span class="ruby-operator">|</span> <span class="ruby-identifier">q</span>.<span class="ruby-identifier">echo</span> = <span class="ruby-string">&quot;*&quot;</span> }
        <span class="ruby-keyword">end</span>
        <span class="ruby-comment"># End of Username and password</span>
        
        <span class="ruby-comment"># Open up a temperory file for cURL cookies</span>
        <span class="ruby-ivar">@temp_handle</span> = <span class="ruby-constant">Tempfile</span>.<span class="ruby-identifier">new</span>(<span class="ruby-string">'RubyWiki-cookie'</span>) <span class="ruby-comment"># create</span>
        <span class="ruby-ivar">@temp</span> = <span class="ruby-ivar">@temp_handle</span>.<span class="ruby-identifier">path</span> <span class="ruby-comment"># Get path</span>
        <span class="ruby-ivar">@temp_handle</span>.<span class="ruby-identifier">close</span> <span class="ruby-comment"># Close handle</span>
        
        <span class="ruby-comment"># Open the log file</span>
        <span class="ruby-ivar">@log</span> = <span class="ruby-constant">File</span>.<span class="ruby-identifier">open</span>(<span class="ruby-constant">ConfigDir</span> <span class="ruby-operator">+</span> <span class="ruby-string">'rubywiki.log'</span>, <span class="ruby-string">'a'</span>)
        
        <span class="ruby-comment"># Max Slave DB lag level</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">max_lag</span> 
                <span class="ruby-ivar">@max_lag</span> = <span class="ruby-identifier">max_lag</span>
        <span class="ruby-keyword">else</span>
                <span class="ruby-ivar">@max_lag</span> = <span class="ruby-value">5</span>
        <span class="ruby-keyword">end</span>
        
        <span class="ruby-comment"># Define Destructor</span>
        <span class="ruby-constant">ObjectSpace</span>.<span class="ruby-identifier">define_finalizer</span>(<span class="ruby-keyword">self</span>, <span class="ruby-keyword">self</span>.<span class="ruby-identifier">method</span>(<span class="ruby-value">:finalize</span>).<span class="ruby-identifier">to_proc</span>)
        
        <span class="ruby-comment"># Initialize cURL Handles</span>
        <span class="ruby-identifier">init_curl!</span>
        
        <span class="ruby-comment"># Debug Log</span>
        <span class="ruby-identifier">log</span> <span class="ruby-node">&quot;RubyWiki/#{RBW_VERSION} started&quot;</span>, <span class="ruby-constant">LL_DEBUG</span>
        <span class="ruby-identifier">log</span> <span class="ruby-node">&quot;Ruby Version #{RUBY_VERSION}-p#{RUBY_PATCHLEVEL}&quot;</span>, <span class="ruby-constant">LL_DEBUG</span>
        
        <span class="ruby-comment"># Login</span>
        <span class="ruby-identifier">login!</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- new-source -->
            
          </div>

          

          
        </div><!-- new-method -->

      
      </div><!-- public-class-method-details -->
    
      <div id="public-instance-method-details" class="method-section section">
        <h3 class="section-header">Public Instance Methods</h3>

      
        <div id="finalize-method" class="method-detail ">
          <a name="method-i-finalize"></a>

          
          <div class="method-heading">
            <span class="method-name">finalize</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Finalizer, destory the temperory file and close the log file</p>
            

            
            <div class="method-source-code" id="finalize-source">
<pre>
<span class="ruby-comment"># File init.rb, line 172</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">finalize</span>
        <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">close</span>
        <span class="ruby-ivar">@temp_handle</span>.<span class="ruby-identifier">unlink</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- finalize-source -->
            
          </div>

          

          
        </div><!-- finalize-method -->

      
        <div id="site_info_general-method" class="method-detail ">
          <a name="method-i-site_info_general"></a>

          
          <div class="method-heading">
            <span class="method-name">site_info_general</span><span
              class="method-args">(type = nil)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Fetches the General Wiki Info</p>
            

            
            <div class="method-source-code" id="site_info_general-source">
<pre>
<span class="ruby-comment"># File query.rb, line 11</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">site_info_general</span> (<span class="ruby-identifier">type</span> = <span class="ruby-keyword">nil</span>)
        <span class="ruby-identifier">resp</span> = <span class="ruby-identifier">get_api</span> <span class="ruby-string">'action=query&amp;meta=siteinfo'</span>
        <span class="ruby-keyword">unless</span> <span class="ruby-identifier">resp</span>.<span class="ruby-identifier">instance_of?</span><span class="ruby-constant">Hash</span>
                <span class="ruby-identifier">exception</span> <span class="ruby-constant">RbWikiErr</span><span class="ruby-operator">::</span><span class="ruby-constant">Query</span><span class="ruby-operator">::</span><span class="ruby-constant">General</span>, <span class="ruby-value">301</span>, <span class="ruby-string">'Can\t Query'</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">type</span>
                <span class="ruby-identifier">exception</span> <span class="ruby-constant">RbWikiErr</span><span class="ruby-operator">::</span><span class="ruby-constant">Query</span><span class="ruby-operator">::</span><span class="ruby-constant">GeneralSiteInfo</span>, <span class="ruby-value">310</span>, <span class="ruby-string">'No Such Type'</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">resp</span>[<span class="ruby-string">'query'</span>][<span class="ruby-string">'general'</span>][<span class="ruby-identifier">type</span>]
                <span class="ruby-keyword">return</span> <span class="ruby-identifier">resp</span>[<span class="ruby-string">'query'</span>][<span class="ruby-string">'general'</span>][<span class="ruby-identifier">type</span>]
        <span class="ruby-keyword">else</span>
                <span class="ruby-keyword">return</span> <span class="ruby-identifier">resp</span>[<span class="ruby-string">'query'</span>][<span class="ruby-string">'general'</span>]
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- site_info_general-source -->
            
          </div>

          

          
        </div><!-- site_info_general-method -->

      
        <div id="urldecode-method" class="method-detail ">
          <a name="method-i-urldecode"></a>

          
          <div class="method-heading">
            <span class="method-name">urldecode</span><span
              class="method-args">(string)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>URL Decode a string, copied from cgi/utils.rb, CGI::unescape</p>
            

            
            <div class="method-source-code" id="urldecode-source">
<pre>
<span class="ruby-comment"># File init.rb, line 185</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">urldecode</span>(<span class="ruby-identifier">string</span>)
        <span class="ruby-identifier">str</span>=<span class="ruby-identifier">string</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-string">'+'</span>, <span class="ruby-string">' '</span>).<span class="ruby-identifier">force_encoding</span>(<span class="ruby-constant">Encoding</span><span class="ruby-operator">::</span><span class="ruby-constant">ASCII_8BIT</span>).<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/((?:%[0-9a-fA-F]{2})+)/</span>) <span class="ruby-keyword">do</span>
                [<span class="ruby-node">$1</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-string">'%'</span>)].<span class="ruby-identifier">pack</span>(<span class="ruby-string">'H*'</span>)
        <span class="ruby-keyword">end</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-string">'UTF-8'</span>)
        <span class="ruby-identifier">str</span>.<span class="ruby-identifier">valid_encoding?</span> <span class="ruby-operator">?</span> <span class="ruby-identifier">str</span> <span class="ruby-operator">:</span> <span class="ruby-identifier">str</span>.<span class="ruby-identifier">force_encoding</span>(<span class="ruby-identifier">string</span>.<span class="ruby-identifier">encoding</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- urldecode-source -->
            
          </div>

          

          
        </div><!-- urldecode-method -->

      
        <div id="urlencode-method" class="method-detail ">
          <a name="method-i-urlencode"></a>

          
          <div class="method-heading">
            <span class="method-name">urlencode</span><span
              class="method-args">(string)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>URL Encode a string, copied from cgi/utils.rb, CGI::escape</p>
            

            
            <div class="method-source-code" id="urlencode-source">
<pre>
<span class="ruby-comment"># File init.rb, line 178</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">urlencode</span>(<span class="ruby-identifier">string</span>)
        <span class="ruby-identifier">string</span>.<span class="ruby-identifier">gsub</span>(<span class="ruby-regexp">/([^ a-zA-Z0-9_.-]+)/</span>) <span class="ruby-keyword">do</span>
                <span class="ruby-string">'%'</span> <span class="ruby-operator">+</span> <span class="ruby-node">$1</span>.<span class="ruby-identifier">unpack</span>(<span class="ruby-string">'H2'</span> * <span class="ruby-node">$1</span>.<span class="ruby-identifier">bytesize</span>).<span class="ruby-identifier">join</span>(<span class="ruby-string">'%'</span>).<span class="ruby-identifier">upcase</span>
        <span class="ruby-keyword">end</span>.<span class="ruby-identifier">tr</span>(<span class="ruby-string">' '</span>, <span class="ruby-string">'+'</span>)
<span class="ruby-keyword">end</span></pre>
            </div><!-- urlencode-source -->
            
          </div>

          

          
        </div><!-- urlencode-method -->

      
      </div><!-- public-instance-method-details -->
    
      <div id="protected-instance-method-details" class="method-section section">
        <h3 class="section-header">Protected Instance Methods</h3>

      
        <div id="exception-method" class="method-detail ">
          <a name="method-i-exception"></a>

          
          <div class="method-heading">
            <span class="method-name">exception</span><span
              class="method-args">(type, code, message)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Throw an exception in the way of <a href="RubyWiki.html">RubyWiki</a></p>
            

            
            <div class="method-source-code" id="exception-source">
<pre>
<span class="ruby-comment"># File init.rb, line 296</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">exception</span>(<span class="ruby-identifier">type</span>, <span class="ruby-identifier">code</span>, <span class="ruby-identifier">message</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-regexp">/^(.+?):(\d+)(?::in `(.*)')?/</span> <span class="ruby-operator">=~</span> <span class="ruby-identifier">caller</span>()[<span class="ruby-value">0</span>]
                <span class="ruby-identifier">method</span> = <span class="ruby-constant">Regexp</span>.<span class="ruby-identifier">last_match</span>[<span class="ruby-value">3</span>]
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">log</span>(<span class="ruby-node">&quot;Exception #{type.to_s} raised in '#{method}'!!!&quot;</span>, <span class="ruby-constant">LL_ERROR</span>)
        <span class="ruby-identifier">raise</span> <span class="ruby-identifier">type</span>, <span class="ruby-identifier">code</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">message</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- exception-source -->
            
          </div>

          

          
        </div><!-- exception-method -->

      
        <div id="get_api-method" class="method-detail ">
          <a name="method-i-get_api"></a>

          
          <div class="method-heading">
            <span class="method-name">get_api</span><span
              class="method-args">(query)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Perform a get request to API, please urlencode the query string</p>
            

            
            <div class="method-source-code" id="get_api-source">
<pre>
<span class="ruby-comment"># File init.rb, line 261</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">get_api</span>(<span class="ruby-identifier">query</span>)
        <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">url</span> = <span class="ruby-node">&quot;#{@api_url}?#{query}&amp;maxlag=#{@max_lag}&amp;format=yaml&quot;</span>
        <span class="ruby-keyword">begin</span>
                <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">http_get</span>
                <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load</span>(<span class="ruby-ivar">@get</span>.<span class="ruby-identifier">body_str</span>)
        <span class="ruby-keyword">rescue</span>
                <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- get_api-source -->
            
          </div>

          

          
        </div><!-- get_api-method -->

      
        <div id="init_curl-21-method" class="method-detail ">
          <a name="method-i-init_curl-21"></a>

          
          <div class="method-heading">
            <span class="method-name">init_curl!</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>cURL Handles Initiailzers</p>
            

            
            <div class="method-source-code" id="init_curl-21-source">
<pre>
<span class="ruby-comment"># File init.rb, line 247</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">init_curl!</span>
        <span class="ruby-ivar">@get</span> = <span class="ruby-constant">Curl</span><span class="ruby-operator">::</span><span class="ruby-constant">Easy</span>.<span class="ruby-identifier">new</span>()
        <span class="ruby-ivar">@post</span> = <span class="ruby-constant">Curl</span><span class="ruby-operator">::</span><span class="ruby-constant">Easy</span>.<span class="ruby-identifier">new</span>(<span class="ruby-ivar">@api_url</span>)
        <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">enable_cookies</span> = <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">enable_cookies</span> = <span class="ruby-keyword">true</span>
        <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">useragent</span>  = <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">useragent</span>  = <span class="ruby-ivar">@useragent</span>
        <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">cookiejar</span> = <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">cookiejar</span> = <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">cookiefile</span> = <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">cookiefile</span> = <span class="ruby-ivar">@temp</span>
        <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">headers</span>    = <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">headers</span>    = [
                <span class="ruby-string">'Connection: keep-alive'</span>,
                <span class="ruby-string">'Keep-Alive: 300'</span>,
                ]
        <span class="ruby-ivar">@get</span>.<span class="ruby-identifier">encoding</span>   = <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">encoding</span>   = <span class="ruby-string">'gzip, deflate'</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- init_curl-21-source -->
            
          </div>

          

          
        </div><!-- init_curl-21-method -->

      
        <div id="log-method" class="method-detail ">
          <a name="method-i-log"></a>

          
          <div class="method-heading">
            <span class="method-name">log</span><span
              class="method-args">(data, level = LL_INFO, fmt = '%Y-%m-%d %H-%M-%S.%L')</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Log an error with level of `level’ and a strftime</p>
            

            
            <div class="method-source-code" id="log-source">
<pre>
<span class="ruby-comment"># File init.rb, line 287</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">log</span>(<span class="ruby-identifier">data</span>, <span class="ruby-identifier">level</span> = <span class="ruby-constant">LL_INFO</span>, <span class="ruby-identifier">fmt</span> = <span class="ruby-string">'%Y-%m-%d %H-%M-%S.%L'</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-ivar">@loglevel</span> <span class="ruby-operator">&lt;=</span> <span class="ruby-identifier">level</span>
                <span class="ruby-identifier">write</span> = <span class="ruby-constant">Time</span>.<span class="ruby-identifier">now</span>.<span class="ruby-identifier">strftime</span>(<span class="ruby-identifier">fmt</span>) <span class="ruby-operator">+</span> <span class="ruby-string">' - '</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">data</span>
                <span class="ruby-ivar">@log</span>.<span class="ruby-identifier">write</span> <span class="ruby-identifier">write</span> <span class="ruby-operator">+</span> <span class="ruby-constant">EOL</span>
                <span class="ruby-identifier">$stderr</span>.<span class="ruby-identifier">puts</span> <span class="ruby-identifier">write</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- log-source -->
            
          </div>

          

          
        </div><!-- log-method -->

      
        <div id="login-21-method" class="method-detail ">
          <a name="method-i-login-21"></a>

          
          <div class="method-heading">
            <span class="method-name">login!</span><span
              class="method-args">()</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Internal method to log into the wiki</p>
            

            
            <div class="method-source-code" id="login-21-source">
<pre>
<span class="ruby-comment"># File init.rb, line 194</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">login!</span>
        <span class="ruby-identifier">resp</span> = <span class="ruby-identifier">post_api</span>({
                        <span class="ruby-string">'action'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'login'</span>,
                        <span class="ruby-string">'lgname'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user</span>,
                        <span class="ruby-string">'lgpassword'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pass</span>,
                })
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">resp</span>[<span class="ruby-string">'login'</span>][<span class="ruby-string">'result'</span>] 
                <span class="ruby-keyword">when</span> <span class="ruby-string">'Success'</span>
                        <span class="ruby-comment"># Unpatched server, all done. (See bug #23076, April 2010)</span>
                        <span class="ruby-identifier">log</span> <span class="ruby-node">&quot;\&quot;#{@user}\&quot; logged into wiki \&quot;#{@wikiname}\&quot;&quot;</span>, <span class="ruby-constant">LL_INFO</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">'NeedToken'</span>
                        <span class="ruby-identifier">resp</span> = <span class="ruby-identifier">post_api</span>({
                                        <span class="ruby-string">'action'</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-string">'login'</span>,
                                        <span class="ruby-string">'lgname'</span>     =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@user</span>,
                                        <span class="ruby-string">'lgpassword'</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-ivar">@pass</span>,
                                        <span class="ruby-string">'lgtoken'</span>    =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">resp</span>[<span class="ruby-string">'login'</span>][<span class="ruby-string">'token'</span>],
                                })
                        <span class="ruby-identifier">login_code_check!</span> <span class="ruby-identifier">resp</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">login_code_check!</span> <span class="ruby-identifier">resp</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- login-21-source -->
            
          </div>

          

          
        </div><!-- login-21-method -->

      
        <div id="login_code_check-21-method" class="method-detail ">
          <a name="method-i-login_code_check-21"></a>

          
          <div class="method-heading">
            <span class="method-name">login_code_check!</span><span
              class="method-args">(resp)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Check the login response and log/throw exception</p>
            

            
            <div class="method-source-code" id="login_code_check-21-source">
<pre>
<span class="ruby-comment"># File init.rb, line 218</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">login_code_check!</span> (<span class="ruby-identifier">resp</span>)
        <span class="ruby-keyword">case</span> <span class="ruby-identifier">resp</span>[<span class="ruby-string">'login'</span>][<span class="ruby-string">'result'</span>]
                <span class="ruby-keyword">when</span> <span class="ruby-string">'Success'</span>
                        <span class="ruby-identifier">log</span> <span class="ruby-node">&quot;\&quot;#{@user}\&quot; logged into wiki \&quot;#{@wikiname}\&quot;&quot;</span>, <span class="ruby-constant">LL_INFO</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">'Throttled'</span>
                        <span class="ruby-identifier">log</span> <span class="ruby-node">&quot;\&quot;#{@user}\&quot; needs to wait #{resp['login']['wait']} seconds to log into wiki \&quot;#{@wikiname}\&quot;!&quot;</span>, <span class="ruby-constant">LL_WARN</span>
                        <span class="ruby-identifier">sleep</span> <span class="ruby-identifier">resp</span>[<span class="ruby-string">'login'</span>][<span class="ruby-string">'wait'</span>]
                        <span class="ruby-identifier">login!</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">'EmptyPass'</span>, <span class="ruby-string">'WrongPass'</span>, <span class="ruby-string">'WrongPluginPass'</span>
                        <span class="ruby-identifier">exception</span> <span class="ruby-constant">RbWikiErr</span><span class="ruby-operator">::</span><span class="ruby-constant">Login</span>, <span class="ruby-value">102</span>, <span class="ruby-string">'Wrong Password'</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">'Blocked'</span>, <span class="ruby-string">'CreateBlocked'</span>
                        <span class="ruby-identifier">exception</span> <span class="ruby-constant">RbWikiErr</span><span class="ruby-operator">::</span><span class="ruby-constant">General</span>, <span class="ruby-value">32</span>, <span class="ruby-string">'Blocked'</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">'NotExists'</span>
                        <span class="ruby-identifier">exception</span> <span class="ruby-constant">RbWikiErr</span><span class="ruby-operator">::</span><span class="ruby-constant">General</span>, <span class="ruby-value">31</span>, <span class="ruby-string">'No Such User'</span>
                <span class="ruby-keyword">when</span> <span class="ruby-string">'Illegal'</span>
                        <span class="ruby-identifier">exception</span> <span class="ruby-constant">RbWikiErr</span><span class="ruby-operator">::</span><span class="ruby-constant">Login</span>, <span class="ruby-value">101</span>, <span class="ruby-string">'Illegal User'</span>
                <span class="ruby-keyword">else</span>
                        <span class="ruby-identifier">puts</span> <span class="ruby-string">'This is an error that wasn\t handled by RubyWiki. This'</span>
                        <span class="ruby-identifier">puts</span> <span class="ruby-string">&quot;might indicate a bug. Please report it to:&quot;</span>
                        <span class="ruby-identifier">puts</span> <span class="ruby-identifier">@@bugtrac</span>
                        <span class="ruby-identifier">puts</span> <span class="ruby-string">'The following is an error dump, attach it to the report:'</span>
                        <span class="ruby-identifier">puts</span> <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">dump</span>(<span class="ruby-identifier">resp</span>)
                        <span class="ruby-identifier">exception</span> <span class="ruby-constant">RbWikiErr</span><span class="ruby-operator">::</span><span class="ruby-constant">Login</span>, <span class="ruby-value">100</span>, <span class="ruby-string">'Login Error'</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- login_code_check-21-source -->
            
          </div>

          

          
        </div><!-- login_code_check-21-method -->

      
        <div id="post_api-method" class="method-detail ">
          <a name="method-i-post_api"></a>

          
          <div class="method-heading">
            <span class="method-name">post_api</span><span
              class="method-args">(data, multipart = false)</span>
            <span class="method-click-advice">click to toggle source</span>
          </div>
          

          <div class="method-description">
            
            <p>Perform a post request to API, please use an array</p>
            

            
            <div class="method-source-code" id="post_api-source">
<pre>
<span class="ruby-comment"># File init.rb, line 272</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">post_api</span>(<span class="ruby-identifier">data</span>, <span class="ruby-identifier">multipart</span> = <span class="ruby-keyword">false</span>)
        <span class="ruby-identifier">query</span> = <span class="ruby-string">''</span>
        <span class="ruby-identifier">data</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">var</span>, <span class="ruby-identifier">content</span><span class="ruby-operator">|</span>
                <span class="ruby-identifier">query</span> <span class="ruby-operator">+=</span> <span class="ruby-identifier">var</span> <span class="ruby-operator">+</span> <span class="ruby-string">'='</span> <span class="ruby-operator">+</span> <span class="ruby-identifier">urlencode</span>(<span class="ruby-identifier">content</span>) <span class="ruby-operator">+</span> <span class="ruby-string">'&amp;'</span>
        <span class="ruby-keyword">end</span>
        <span class="ruby-identifier">query</span> <span class="ruby-operator">+=</span> <span class="ruby-string">'format=yaml'</span>
        <span class="ruby-keyword">begin</span>
                <span class="ruby-ivar">@post</span>.<span class="ruby-identifier">http_post</span> <span class="ruby-identifier">query</span>
                <span class="ruby-constant">YAML</span><span class="ruby-operator">::</span><span class="ruby-identifier">load</span>(<span class="ruby-ivar">@post</span>.<span class="ruby-identifier">body_str</span>)
        <span class="ruby-keyword">rescue</span>
                <span class="ruby-keyword">false</span>
        <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
            </div><!-- post_api-source -->
            
          </div>

          

          
        </div><!-- post_api-method -->

      
      </div><!-- protected-instance-method-details -->
    
    </div><!-- 5Buntitled-5D -->
  

  </div><!-- documentation -->

  <div id="validator-badges">
    <p><small><a href="http://validator.w3.org/check/referer">[Validate]</a></small></p>
    <p><small>Generated with the <a href="http://deveiate.org/projects/Darkfish-Rdoc/">Darkfish
      Rdoc Generator</a> 2</small>.</p>
  </div>

</body>
</html>

